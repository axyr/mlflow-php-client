#!/bin/bash

# Pre-commit hook to run code quality checks
# This prevents commits that would fail CI/CD pipeline
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# 1. PHPStan (Static Analysis)
echo "ğŸ“Š Running PHPStan (Level 9)..."
if composer phpstan --quiet; then
    echo -e "${GREEN}âœ“ PHPStan passed${NC}"
else
    echo -e "${RED}âœ— PHPStan failed${NC}"
    FAILED=1
fi
echo ""

# 2. Code Style Check
echo "ğŸ¨ Running Code Style Check (PSR-12)..."
CS_OUTPUT=$(composer cs-check 2>&1) || true
if echo "$CS_OUTPUT" | grep -q "FOUND [1-9][0-9]* ERROR"; then
    echo -e "${RED}âœ— Code style has ERRORS${NC}"
    echo "$CS_OUTPUT" | grep "ERROR" | head -5
    FAILED=1
elif echo "$CS_OUTPUT" | grep -q "WARNING"; then
    echo -e "${YELLOW}âš  Code style has warnings (acceptable)${NC}"
    echo -e "${GREEN}âœ“ Code style check passed${NC}"
else
    echo -e "${GREEN}âœ“ Code style passed${NC}"
fi
echo ""

# 3. Unit Tests
echo "ğŸ§ª Running Unit Tests..."
TEST_OUTPUT=$(composer test 2>&1) || true
if echo "$TEST_OUTPUT" | grep -q "OK"; then
    echo -e "${GREEN}âœ“ Unit tests passed${NC}"
elif echo "$TEST_OUTPUT" | grep -q "FAILURES\|ERRORS"; then
    echo -e "${RED}âœ— Unit tests failed${NC}"
    echo "$TEST_OUTPUT" | tail -10
    FAILED=1
else
    # Tests passed but with warnings (coverage driver, deprecations)
    echo -e "${GREEN}âœ“ Unit tests passed (with warnings)${NC}"
fi
echo ""

# Final result
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âœ— Pre-commit checks FAILED${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Please fix the errors above before committing."
    echo "To skip this hook (not recommended), use: git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    exit 0
fi
