#!/bin/bash

# Run all CI/CD checks locally before pushing
# This script mirrors exactly what GitHub Actions runs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Running Complete CI/CD Check Suite${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Track overall status
OVERALL_STATUS=0

# ============================================================================
# 1. Unit Tests
# ============================================================================
echo -e "${BLUE}[1/4] 🧪 Unit Tests${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if composer test; then
    echo -e "${GREEN}✓ Unit tests passed${NC}"
else
    echo -e "${RED}✗ Unit tests failed${NC}"
    OVERALL_STATUS=1
fi
echo ""

# ============================================================================
# 2. PHPStan Static Analysis
# ============================================================================
echo -e "${BLUE}[2/4] 📊 PHPStan (Level 9)${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if composer phpstan; then
    echo -e "${GREEN}✓ PHPStan passed${NC}"
else
    echo -e "${RED}✗ PHPStan failed${NC}"
    OVERALL_STATUS=1
fi
echo ""

# ============================================================================
# 3. Code Style Check
# ============================================================================
echo -e "${BLUE}[3/4] 🎨 Code Style (PSR-12)${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
CS_OUTPUT=$(composer cs-check 2>&1) || true
echo "$CS_OUTPUT"

if echo "$CS_OUTPUT" | grep -q "ERROR"; then
    echo -e "${RED}✗ Code style has ERRORS${NC}"
    OVERALL_STATUS=1
elif echo "$CS_OUTPUT" | grep -q "WARNING"; then
    echo -e "${YELLOW}⚠ Code style has warnings (acceptable)${NC}"
    echo -e "${GREEN}✓ Code style check passed (warnings are OK)${NC}"
else
    echo -e "${GREEN}✓ Code style perfect${NC}"
fi
echo ""

# ============================================================================
# 4. Integration Tests (Optional - requires Docker)
# ============================================================================
echo -e "${BLUE}[4/4] 🐳 Integration Tests (Optional)${NC}"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo -e "${YELLOW}⊘ Docker not found - skipping integration tests${NC}"
    echo "  Install Docker to run integration tests"
elif [ "$SKIP_INTEGRATION" = "1" ]; then
    echo -e "${YELLOW}⊘ Integration tests skipped (SKIP_INTEGRATION=1)${NC}"
else
    echo "Starting MLflow server and running integration tests..."
    echo "(This may take 2-3 minutes on first run)"
    echo ""

    if docker-compose -f docker-compose.test.yml up --abort-on-container-exit --remove-orphans; then
        echo -e "${GREEN}✓ Integration tests passed${NC}"
    else
        echo -e "${RED}✗ Integration tests failed${NC}"
        OVERALL_STATUS=1
    fi

    # Cleanup
    docker-compose -f docker-compose.test.yml down -v 2>/dev/null || true
fi
echo ""

# ============================================================================
# Final Summary
# ============================================================================
echo ""
if [ $OVERALL_STATUS -eq 0 ]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  ✓ ALL CHECKS PASSED${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Your code is ready to push! 🚀"
    echo ""
    exit 0
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}  ✗ SOME CHECKS FAILED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Please fix the errors above before pushing."
    echo ""
    exit 1
fi
